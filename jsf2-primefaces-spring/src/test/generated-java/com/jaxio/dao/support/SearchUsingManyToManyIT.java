/*
 * (c) Copyright 2005-2013 JAXIO, http://www.jaxio.com
 * Source code generated by Celerio, a Jaxio product
 * Want to use Celerio within your company? email us at info@jaxio.com
 * Follow us on twitter: @springfuse
 * Template pack-backend-jpa:src/test/java/dao/support/SearchUsingManyToManyIT.p.vm.java
 */
package com.jaxio.dao.support;

import static org.fest.assertions.Assertions.assertThat;

import javax.inject.Inject;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.transaction.annotation.Transactional;

import com.jaxio.domain.Account;
import com.jaxio.domain.Account_;
import com.jaxio.repository.AccountRepository;
import com.jaxio.repository.RoleRepository;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = { "classpath*:spring/applicationContext-test.xml" })
@Transactional
public class SearchUsingManyToManyIT {
    @Inject
    private AccountRepository accountRepository;

    @Inject
    private RoleRepository roleRepository;

    @Test
    public void useAND() {
        Account account = buildAccount();
        verifySize(account, sp().useANDInManyToMany(), 1);
        verifySize(account, sp().useANDInManyToMany().orderBy(Account_.email), 1);
        verifySize(account, sp().useANDInManyToMany().useDistinct(), 1);
        verifySize(account, sp().useANDInManyToMany().useDistinct().orderBy(Account_.email), 1);
        verifySize(account, sp().useANDInManyToMany().useDistinct().leftJoin(Account_.homeAddress), 1);
        verifySize(account, sp().useANDInManyToMany().useDistinct().leftJoin(Account_.homeAddress).orderBy("homeAddress.city"), 1);
    }

    @Test
    public void useOR() {
        Account account = buildAccount();
        verifySize(account, sp().useORInManyToMany(), 4);
        verifySize(account, sp().useORInManyToMany().orderBy(Account_.email), 4);
        verifySize(account, sp().useORInManyToMany().useDistinct(), 3);
        verifySize(account, sp().useORInManyToMany().useDistinct().orderBy(Account_.email), 3);
        verifySize(account, sp().useORInManyToMany().useDistinct().leftJoin(Account_.homeAddress), 3);
        verifySize(account, sp().useORInManyToMany().useDistinct().leftJoin(Account_.homeAddress).orderBy("homeAddress.city"), 3);

    }

    private Account buildAccount() {
        Account account = new Account();
        account.addRole(roleRepository.getByRoleName("ROLE_ADMIN"));
        account.addRole(roleRepository.getByRoleName("ROLE_USER"));
        return account;
    }

    private void verifySize(Account account, SearchParameters s, int expectedSize) {
        assertThat(accountRepository.find(account, s)).hasSize(expectedSize);
        assertThat(accountRepository.findCount(account, s)).isEqualTo(expectedSize);
    }

    public static SearchParameters sp() {
        return new SearchParameters();
    }
}
